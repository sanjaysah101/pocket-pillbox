<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pocket Pillbox ‚Äì Offline Med Reminder</title>
    <style>
        html {
            box-sizing: border-box;
            font-size: 18px;
            background: #f8fafc;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: inherit;
            transition: background 0.3s, color 0.3s;
        }

        header {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 2.1rem;
            font-weight: bold;
            color: #057fa3;
            text-align: center;
            user-select: none;
        }

        main {
            width: 100%;
            max-width: 960px;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.10);
            padding: 1.5rem 1.2rem 2.5rem 1.2rem;
            margin-bottom: 2rem;
            display: flex;
        }

        form {
            margin-bottom: 0;
            flex: 1 1 45%;
        }

        fieldset {
            border: 2px solid #cbe0fb;
            border-radius: 0.75em;
            padding: 1em;
            margin: 0;
            background: #eaf7ff;
            display: flex;
            flex-direction: column;
            gap: 0.8em;
        }

        legend {
            font-weight: bold;
            color: #036ba2;
            font-size: 1.12em;
            transition: color 0.2s;
            user-select: none;
        }

        label {
            display: flex;
            align-items: center;
            font-size: 1em;
            gap: 0.6em;
        }

        input[type="text"],
        input[type="time"] {
            font-size: 1em;
            padding: 0.4em 0.6em;
            border: 2px solid #b7dfff;
            border-radius: 0.4em;
            outline: none;
            flex: 1;
            background: #f6fcff;
            transition: border-color 0.2s, background 0.2s;
            min-width: 0;
        }

        input:focus {
            border-color: #1076ba;
            background: #e5f4ff;
        }

        button {
            font-size: 1em;
            padding: 0.6em 1em;
            background-color: #057fa3;
            color: #fff;
            border: none;
            border-radius: 0.5em;
            cursor: pointer;
            margin-top: 0.5em;
            margin-bottom: 0.2em;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px rgba(5, 127, 163, 0.15);
            user-select: none;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 0.4em;
        }

        button:disabled,
        button:disabled:hover,
        button:disabled:focus {
            background-color: #9eafb5;
            color: #f0f4f6;
            cursor: not-allowed;
            box-shadow: none;
            outline: none;
        }

        button:focus,
        button:hover {
            background: #045e7a;
            outline: 2px solid #0a8cd2;
            outline-offset: 2px;
        }

        #clear-all {
            background: #d42323;
            margin-top: 1.1em;
            font-size: 0.98em;
            align-self: flex-start;
            padding-left: 1.2em;
            padding-right: 1.2em;
            box-shadow: 0 3px 8px rgba(212, 35, 35, 0.4);
            transition: background 0.3s, box-shadow 0.3s;
        }

        #clear-all:focus,
        #clear-all:hover {
            background: #b11414;
            box-shadow: 0 4px 12px rgba(177, 20, 20, 0.6);
        }

        section#reminders-section {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            margin-left: 2rem;
        }

        h2 {
            font-size: 1.23em;
            margin-bottom: 0.6em;
            color: #2479bb;
            user-select: none;
        }

        ul#reminders-list {
            padding: 0;
            list-style: none;
            margin-bottom: 0.6em;
            min-height: 2.2em;
            display: flex;
            flex-direction: column;
            gap: 0.5em;
            max-height: 60vh;
            overflow-y: auto;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            background: #f3faff;
            border: 1.5px solid #b1dafd;
            border-radius: 0.45em;
            padding: 0.7em 0.8em 0.7em 0.55em;
            font-size: 1.09em;
            transition: background 0.15s;
            gap: 0.5em;
        }

        @keyframes newItemAnim {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .reminder-item.new-item {
            animation: newItemAnim 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .no-reminders-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 2rem 1rem;
            color: #889ab2;
            font-size: 1.05em;
            user-select: none;
        }

        .no-reminders-message small {
            margin-top: 0.25em;
            font-size: 0.9em;
            color: #a0aec0;
        }

        .reminder-item.checked {
            background: #dfa;
            opacity: 0.65;
            text-decoration: line-through;
        }

        .reminder-checkbox {
            accent-color: #057fa3;
            width: 1.3em;
            height: 1.3em;
            cursor: pointer;
            flex-shrink: 0;
        }

        .reminder-info {
            flex: 1;
            min-width: 0;
            overflow-wrap: break-word;
        }

        .reminder-time {
            color: #158034;
            font-size: 0.96em;
            white-space: nowrap;
            user-select: none;
        }

        .edit-pill-btn,
        .delete-pill-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: #036ba2;
            padding: 0.2em 0.4em;
            font-size: 1em;
            transition: color 0.15s, background 0.15s;
            border-radius: 0.3em;
            user-select: none;
            flex-shrink: 0;
        }

        .edit-pill-btn:hover,
        .delete-pill-btn:hover {
            color: #FF9800;
            background: #e5f4ff;
        }

        .delete-pill-btn {
            color: #b11414;
        }

        .delete-pill-btn:hover {
            color: #fff;
            background: #d42323;
        }

        #toggle-dark {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 1.2em;
            background: #222;
            color: #fff;
            border-radius: 0.7em;
            border: none;
            padding: 0.48em 0.75em;
            cursor: pointer;
            transition: background 0.16s, color 0.18s;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        #toggle-dark:hover {
            background: #333;
        }

        @media (max-width: 900px) {
            main {
                flex-direction: column;
                max-width: 440px;
                padding: 1.1rem 0.5rem 1.8rem 0.5rem;
            }

            section#reminders-section {
                margin-left: 0;
                margin-top: 2rem;
            }
        }

        @media (max-width: 600px) {
            html {
                font-size: 16px;
            }

            #toggle-dark {
                right: 0.65rem;
            }
        }

        /* --- Dark Mode --- */
        body.dark {
            background: #20262b;
            color: #eee;
        }

        body.dark main {
            background: #23262c;
            color: #eee;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.2);
        }

        body.dark fieldset {
            background: #232f35;
            border: 2px solid #495c68;
        }

        body.dark legend,
        body.dark h2 {
            color: #9bdcff;
        }

        body.dark .reminder-item {
            background: #1b2630;
            border: 1.5px solid #3db3da;
        }

        body.dark .reminder-item.checked {
            background: #375647;
            color: #c5c5c5;
        }

        body.dark input,
        body.dark input:focus {
            background: #151b20;
            color: #edf8fc;
            border-color: #406887;
        }

        body.dark button {
            background-color: #155218;
            color: #cdf6fa;
        }

        body.dark button:disabled,
        body.dark button:disabled:hover,
        body.dark button:disabled:focus {
            background-color: #3a4a53;
            color: #788a95;
        }

        body.dark button#clear-all {
            background: #750e19;
        }

        body.dark button#toggle-dark {
            background: #555;
            color: #fff;
        }

        body.dark .no-reminders-message {
            color: #8295a8;
        }

        body.dark .no-reminders-message small {
            color: #6a7b8c;
        }

        body.dark .no-reminders-message svg {
            color: #506477;
        }
    </style>
</head>

<body>
    <header>
        <h1>ü©∫ Pocket Pillbox</h1>
    </header>

    <button id="toggle-dark" aria-label="Switch to dark mode" title="Toggle dark mode">üåô</button>
    <main>
        <form id="pill-form" autocomplete="off">
            <fieldset>
                <legend>üíä Add Medication</legend>
                <label>
                    Name:
                    <input type="text" id="pill-name" maxlength="50" required autocomplete="off" aria-label="Pill name"
                        placeholder="e.g. Aspirin">
                </label>
                <label>
                    Dosage:
                    <input type="text" id="pill-dosage" maxlength="20" autocomplete="off" aria-label="Dosage"
                        placeholder="e.g. 100mg">
                </label>
                <label>
                    Time:
                    <input type="time" id="pill-time" aria-label="Time" placeholder="HH:MM">
                </label>
                <button id="add-btn" type="submit" style="margin-top:0.7em;">
                    Add Reminder
                </button>
            </fieldset>
        </form>

        <section id="reminders-section" aria-label="Today‚Äôs medications">
            <h2>Today‚Äôs Medications</h2>
            <ul id="reminders-list"></ul>
            <button id="clear-all" type="button" aria-label="Clear all reminders">
                üóëÔ∏è Clear All
            </button>
        </section>
    </main>
    <script>
        // --- Pocket Pillbox Core Logic ---
        const FORM = document.getElementById('pill-form');
        const NAME = document.getElementById('pill-name');
        const DOSAGE = document.getElementById('pill-dosage');
        const TIME = document.getElementById('pill-time');
        const LIST = document.getElementById('reminders-list');
        const CLEAR = document.getElementById('clear-all');
        // For edit button text change and state
        const ADD_BTN = document.getElementById('add-btn');
        const LEGEND = FORM.querySelector('legend');

        // Use a unique key to avoid conflict in localStorage
        const STORAGE_KEY = 'pocket-pillbox-reminders-v1';

        // Reminder format: { id, name, dosage, time, taken }
        let reminders = loadReminders();
        let editId = null; // if not null, we're editing

        renderReminders();

        // --- UI Enhancements ---
        ADD_BTN.disabled = NAME.value.trim() === ''; // Disable button if name is empty on load
        NAME.addEventListener('input', () => {
            ADD_BTN.disabled = NAME.value.trim() === '';
        });

        // -- üõéÔ∏è Notification Logic --

        // 1. Ask for permission on load
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        // 2. Helper to send notification
        function sendReminderNotification(reminder) {
            if (Notification.permission === "granted") {
                new Notification("Medication Reminder", {
                    body: `Time to take: ${reminder.name}` + (reminder.dosage ? ` (${reminder.dosage})` : "") + (reminder.time ? ` at ${reminder.time}` : "")
                });
            }
        }

        // 3. Check if current time matches reminder time (within 1 minute tolerance)
        function isTimeDue(reminder) {
            if (!reminder.time) return false;
            const now = new Date();
            const nowHHMM = now.toTimeString().slice(0, 5);
            // For safety, allow a 1-minute window
            const [h, m] = reminder.time.split(':').map(Number);
            return (
                now.getHours() === h &&
                Math.abs(now.getMinutes() - m) < 1
            );
        }

        // 4. Extended Reminder Model to support notifiedToday
        function migrateRemindersForNotifications(reminders) {
            let updated = false;
            reminders.forEach(reminder => {
                if (reminder.notifiedToday === undefined) {
                    reminder.notifiedToday = false;
                    updated = true;
                }
            });
            return updated;
        }
        // Migrate upon load
        if (migrateRemindersForNotifications(reminders)) {
            saveReminders();
        }

        // 5. Reminder polling
        function checkRemindersForNotification() {
            let changed = false;
            reminders.forEach(reminder => {
                if (
                    !reminder.taken &&
                    !reminder.notifiedToday &&
                    isTimeDue(reminder)
                ) {
                    sendReminderNotification(reminder);
                    reminder.notifiedToday = true;
                    changed = true;
                }
            });
            if (changed) saveReminders();
        }
        // Poll every second
        setInterval(checkRemindersForNotification, 1000);

        // 6. Reset notifiedToday at midnight
        function scheduleMidnightReset() {
            const now = new Date();
            const msUntilMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 1, 0) - now;
            setTimeout(() => {
                reminders.forEach(rem => rem.notifiedToday = false);
                saveReminders();
                scheduleMidnightReset();
            }, msUntilMidnight);
        }
        scheduleMidnightReset();

        // 7. When creating a new reminder, attach notifiedToday: false
        // (Already in local code, but let's ensure updates are future-proofed)
        function addReminderWithNotificationFlag(name, dosage, time) {
            const reminder = {
                id: Date.now(),
                name,
                dosage,
                time,
                taken: false,
                notifiedToday: false
            };
            reminders.push(reminder);
            saveReminders();
            return reminder;
        }

        // Patch form submit to use this function
        FORM.addEventListener('submit', function (e) {
            e.preventDefault();
            const name = NAME.value.trim();
            if (!name) return;
            if (editId !== null) {
                // --- Update existing reminder ---
                const rem = reminders.find(r => r.id === editId);
                if (rem) {
                    rem.name = name;
                    rem.dosage = DOSAGE.value.trim();
                    rem.time = TIME.value;
                    // Keep "taken" state as is
                    rem.notifiedToday = false; // reset notification for edited reminder
                    saveReminders();
                    renderReminders();
                }
                // Reset editing state
                editId = null;
                LEGEND.textContent = 'üíä Add Medication';
                ADD_BTN.textContent = 'Add Reminder';
            } else {
                // --- Add new reminder ---
                const newReminder = addReminderWithNotificationFlag(
                    name,
                    DOSAGE.value.trim(),
                    TIME.value
                );
                renderReminders(newReminder.id);
            }
            FORM.reset();
            NAME.focus();
            ADD_BTN.disabled = true;
        });

        // --- Mark As Taken ---
        LIST.addEventListener('change', function (e) {
            if (e.target.classList.contains('reminder-checkbox')) {
                const id = Number(e.target.dataset.id);
                const found = reminders.find(r => r.id === id);
                if (found) {
                    found.taken = e.target.checked;
                    saveReminders();
                    renderReminders();
                }
            }
        });

        // --- Delete & Edit Buttons ---
        LIST.addEventListener('click', function (e) {
            const target = e.target;
            const pillId = Number(target.dataset.id);

            // --- Delete ---
            if (target.classList.contains('delete-pill-btn')) {
                const itemEl = target.closest('.reminder-item');
                if (itemEl && confirm('Delete this reminder?')) {
                    // Animate out
                    itemEl.style.transition = 'all 0.3s ease-out';
                    itemEl.style.opacity = '0';
                    itemEl.style.transform = 'translateX(50px)';

                    setTimeout(() => {
                        reminders = reminders.filter(r => r.id !== pillId);
                        saveReminders();
                        renderReminders();

                        // Reset edit mode if we're deleting the one being edited
                        if (editId === pillId) {
                            editId = null;
                            FORM.reset();
                            ADD_BTN.disabled = true;
                            LEGEND.textContent = 'üíä Add Medication';
                            ADD_BTN.textContent = 'Add Reminder';
                        }
                    }, 300);
                }
            }
            // --- Edit ---
            else if (target.classList.contains('edit-pill-btn')) {
                const toEdit = reminders.find(r => r.id === pillId);
                if (toEdit) {
                    NAME.value = toEdit.name;
                    DOSAGE.value = toEdit.dosage || '';
                    TIME.value = toEdit.time || '';
                    editId = pillId;
                    LEGEND.textContent = '‚úèÔ∏è Edit Medication';
                    ADD_BTN.textContent = 'Update Reminder';
                    ADD_BTN.disabled = false; // Enable button for editing
                    NAME.focus();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });

        // --- Clear All Reminders ---
        CLEAR.addEventListener('click', function () {
            if (reminders.length > 0 && confirm('Clear all reminders?')) {
                reminders = [];
                saveReminders();
                renderReminders();
                // Also reset edit mode, if active
                editId = null;
                FORM.reset();
                ADD_BTN.disabled = true;
                LEGEND.textContent = 'üíä Add Medication';
                ADD_BTN.textContent = 'Add Reminder';
            }
        });

        // --- ESC to cancel editing ---
        FORM.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && editId !== null) {
                editId = null;
                FORM.reset();
                ADD_BTN.disabled = true;
                LEGEND.textContent = 'üíä Add Medication';
                ADD_BTN.textContent = 'Add Reminder';
                NAME.focus();
            }
        });

        // --- LocalStorage Helpers ---
        function loadReminders() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch { return []; }
        }
        function saveReminders() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
        }

        // --- Render Reminders ---
        function renderReminders(newlyAddedId = null) {
            LIST.innerHTML = '';
            if (reminders.length === 0) {
                LIST.innerHTML = `<li class="no-reminders-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 3em; height: 3em; color: #cddbe7; margin-bottom: 0.5em;"><path d="M8 7v.01"/><path d="M16 7v.01"/><path d="M12 12.01V12"/><path d="M12 17.01V17"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
            <span>Nothing scheduled yet.</span>
            <small>Add a medication above to get started.</small>
        </li>`;
                return;
            }

            const sortedReminders = [...reminders].sort((a, b) => {
                if (a.time && b.time) return a.time.localeCompare(b.time);
                if (a.time) return -1; // a has time, b doesn't -> a comes first
                if (b.time) return 1;  // b has time, a doesn't -> b comes first
                return a.id - b.id; // fallback to creation order
            });

            sortedReminders.forEach(reminder => {
                const li = document.createElement('li');
                li.className = 'reminder-item' + (reminder.taken ? ' checked' : '');
                if (reminder.id === newlyAddedId) {
                    li.classList.add('new-item');
                }
                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'reminder-checkbox';
                checkbox.dataset.id = reminder.id;
                checkbox.checked = reminder.taken;
                checkbox.setAttribute('aria-label', `Mark ${reminder.name} as taken`);

                // Info
                const info = document.createElement('span');
                info.className = 'reminder-info';
                info.textContent = `${reminder.name}` + (reminder.dosage ? ` (${reminder.dosage})` : '');

                // Time display
                const timeSpan = document.createElement('span');
                timeSpan.className = 'reminder-time';
                timeSpan.textContent = reminder.time ? `üïë ${reminder.time}` : '';

                // --- EDIT Button ---
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'edit-pill-btn';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Edit reminder';
                editBtn.dataset.id = reminder.id;

                // --- DELETE Button ---
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'delete-pill-btn';
                delBtn.textContent = 'üóëÔ∏è';
                delBtn.title = 'Delete reminder';
                delBtn.dataset.id = reminder.id;

                // Build list item
                li.appendChild(checkbox);
                li.appendChild(info);
                li.appendChild(timeSpan);
                li.appendChild(editBtn);
                li.appendChild(delBtn);
                LIST.appendChild(li);
            });
        }

        // --- Dark mode toggle ---
        const DARK_BTN = document.getElementById('toggle-dark');
        function setDark(state) {
            document.body.classList.toggle('dark', state);
            DARK_BTN.textContent = state ? '‚òÄÔ∏è' : 'üåô';
            DARK_BTN.setAttribute('aria-label', state ? 'Switch to light mode' : 'Switch to dark mode');
            localStorage.setItem('pillbox-dark', state ? '1' : '');
        }
        DARK_BTN.addEventListener('click', () => setDark(!document.body.classList.contains('dark')));
        // Keep mode on reload
        setDark(localStorage.getItem('pillbox-dark') === '1');
    </script>
</body>

</html>